services:
  seen:
    # Use Dockerfile.cuda for CUDA-enabled ffmpeg (required for GPU acceleration)
    image: seen-backend:latest
    build:
      context: .
      dockerfile: Dockerfile.cuda
      args:
        CARGO_BUILD_FLAGS: ${CARGO_BUILD_FLAGS:-}
        CARGO_BUILD_JOBS: ${CARGO_BUILD_JOBS:-}  # Optional: limit build jobs (defaults to all available cores)
    container_name: seen
    environment:
      - FLASH_ROOT=/photos
      - FLASH_ROOT_HOST=${USERPROFILE}/Pictures
      - FLASH_DATA=/flash-data
      - FLASH_PORT=9161
      - RUST_LOG=debug
      - GPU_ACCEL=auto  # Auto-detect CUDA for RTX 4080 Super (or other GPU)
      - SEEN_PROFILE_FLAMEGRAPH=1
    volumes:
      # Uses the current user's Pictures folder
      # ${USERPROFILE} expands to C:\Users\YourUsername on Windows
      - ${USERPROFILE}/Pictures:/photos:rw
      - ./seen-data:/flash-data:rw
      - ./frontend:/app/frontend:ro
      # Mount specific directories for browsing (more secure than mounting entire drive)
      # Only mount the current user's directory, not all users
      - ${USERPROFILE}:/host/user:ro  # Read-only access to current user's directory only
      - C:/Media:/host/media:rw       # If you have a dedicated media directory (create if needed)
      # Uncomment and adjust these if you need access to other locations:
      # - C:/Pictures:/host/pictures:rw
      # - C:/Videos:/host/videos:rw
    ports:
      - "9161:9161"
    deploy:
      resources:
        limits:
          cpus: "${SEEN_CPU_LIMIT:-4.0}"  # 80% of available CPUs (default: 4.0 if not set)
          memory: "${SEEN_MEMORY_LIMIT:-4G}"  # 75% of available RAM, minimum 4 GB (default: 4G if not set)
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # For Intel QSV (Linux only):
    #   devices:
    #     - /dev/dri:/dev/dri:ro
    #   environment:
    #     - GPU_ACCEL=qsv  # or 'auto' for auto-detection
    # For Windows D3D11VA (default on Windows):
    #   environment:
    #     - GPU_ACCEL=d3d11va  # or 'auto' for auto-detection

