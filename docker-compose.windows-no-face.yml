services:
  nazr:
    # Lightweight build WITHOUT facial recognition
    # This reduces binary size by ~200MB and memory usage by ~200-300MB
    # Use Dockerfile.cuda for CUDA-enabled ffmpeg (required for GPU acceleration)
    build:
      context: .
      dockerfile: Dockerfile.cuda
      args:
        CARGO_BUILD_FLAGS: "--no-default-features"
        CARGO_BUILD_JOBS: ${CARGO_BUILD_JOBS:-}  # Optional: limit build jobs (defaults to all available cores)
    container_name: nazr
    environment:
      - FLASH_ROOT=/photos
      - FLASH_ROOT_HOST=${USERPROFILE}/Pictures
      - FLASH_DATA=/flash-data
      - FLASH_PORT=9161
      - GPU_ACCEL=auto  # Auto-detect CUDA for RTX 4080 Super
    volumes:
      # Uses the current user's Pictures folder
      # ${USERPROFILE} expands to C:\Users\YourUsername on Windows
      - ${USERPROFILE}/Pictures:/photos:rw
      - ./nazr-data:/flash-data:rw
      # Mount specific directories for browsing (more secure than mounting entire drive)
      # Only mount the current user's directory, not all users
      - ${USERPROFILE}:/host/user:ro  # Read-only access to current user's directory only
      - C:/Media:/host/media:rw  # If you have a dedicated media directory (create if needed)
      # Uncomment and adjust these if you need access to other locations:
      # - C:/Pictures:/host/pictures:rw
      # - C:/Videos:/host/videos:rw
    ports:
      - "9161:9161"
    deploy:
      resources:
        limits:
          # Use all available CPUs (remove or set to higher value to use more cores)
          # cpus: "2.0"  # Commented out to allow using all available cores
          # Without facial recognition, 1.5GB is sufficient (down from 2GB)
          memory: 1.5G
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    # For Intel QSV (Linux only):
    #   devices:
    #     - /dev/dri:/dev/dri:ro
    #   environment:
    #     - GPU_ACCEL=qsv  # or 'auto' for auto-detection
    # For Windows D3D11VA (default on Windows):
    #   environment:
    #     - GPU_ACCEL=d3d11va  # or 'auto' for auto-detection

